!-------------------------------------------------------------------------------
! Name: select_modis_albedo_file.F90
!
! Purpose:
! Populates the surface albedo part of the surface structure, using MODIS MCD43C
! spectral albedo over the land the cox_munk ocean surface reflectance model
! over the sea.
!
! Description and Algorithm details:
!
! Arguments:
! Name                 Type       In/Out/Both Description
! ------------------------------------------------------------------------------
! cyear                character  in          Year, as a 4 character string
! cdoy                 character  in          DOY,  as a 3 character string
! modis_surf_path      character  in          Path to directory with the
!                                             MCD43C3.A* files
! modis_surf_path_file character  out         Path the the required MCD43C3.A*
!                                             file
!
! History:
! 2012/08/06, CP: Original version
! 2012/08/16, GT: Removed unused variable "mcd_date".
! 2012/08/06, CP: Added in file name extension for 2009 and changed how path is
!    defined i.e year is no longer required in the path name.
! 2012/02/25, CP: Added in 2010 and 2007 data.
! 2013/03/07, GT: Reverted change made by CP on 2012/08/06, and added code to
!    check that the MODIS file exists and is readable.
! 2014/04/21, GM: Cleaned up the code.
! 2014/05/26, MJ: Added "FAILED" to error output.
! 2014/08/10, GM: Changes related to new BRDF support.
! 2014/11/26, CP: Added in 2002-2006 support.
! 2014/12/09, GM: Added support for 2013, better error checking, and cleaned
!    up changes made by CP.
! 2015/03/12, GM: Completed support for 2002 to 2014.
! 2015/07/05, CP: bug fix for 2007 support
!
! $Id$
!
! Bugs:
! There must be a way of searching using regular expressions in fortran to make
! this code cleaner.
! The code should be modified so it selects files from year either side.
!-------------------------------------------------------------------------------

subroutine select_modis_albedo_file(cyear,cdoy,modis_surf_path,include_full_brdf, &
                                    modis_surf_path_file)

   use preproc_structures

   implicit none

   character(len=date_length), intent(in)  :: cyear
   character(len=date_length), intent(in)  :: cdoy
   character(len=path_length), intent(in)  :: modis_surf_path
   logical,                    intent(in)  :: include_full_brdf
   character(len=path_length), intent(out) :: modis_surf_path_file

   integer                                               :: nv
   integer                                               :: doy
   integer(kind=sint), allocatable, dimension(:)         :: dates
   integer(kind=sint), allocatable, dimension(:)         :: newdates
   character(len=date_length), allocatable, dimension(:) :: dates_s
   character(len=path_length), allocatable, dimension(:) :: p_date_s
   integer                                               :: pos(1)
   character(len=3)                                      :: mcd_date_s
   character(len=path_length)                            :: mcd_p_date_s
   logical                                               :: modis_surf_file_exist
   character(len=7)                                      :: modis_surf_file_read

   nv = 46

   allocate(dates(nv))
   allocate(dates_s(nv))
   allocate(p_date_s(nv))

   dates=(/  1,  9, 17, 25, 33, 41, 49, 57, 65, 73, 81, 89, 97,105,113,121,129, &
           137,145,153,161,169,177,185,193,201,209,217,225,233,241,249,257,265, &
           273,281,289,297,305,313,321,329,337,345,353,361/)

   dates_s=(/'001','009','017','025','033','041','049','057','065','073','081', &
             '089','097','105','113','121','129','137','145','153','161','169', &
             '177','185','193','201','209','217','225','233','241','249','257', &
             '265','273','281','289','297','305','313','321','329','337','345', &
             '353','361'/)

   if (trim(adjustl(cyear)) .eq. '2002') then
      if (.not. include_full_brdf) then
         p_date_s=(/'2007116004645','2007117232015','2007122205824','2007123233741', &
                    '2007125143604','2007126054002','2007127134752','2007128050914', &
                    '2007129010114','2007129092152','2007130012142','2007130220528', &
                    '2007131171431','2007132180325','2007135045900','2007139132550', &
                    '2007141072131','2007142175011','2007144144639','2007156142313', &
                    '2007156184225','2007157045934','2007174031633','2007176125949', &
                    '2007177074415','2007178165213','2007185000405','2007187075602', &
                    '2007190140346','2007192170142','2007199233513','2007203075424', &
                    '2007206114256','2007210030319','2007215081912','2007220023455', &
                    '2007226162712','2007229052318','2007239142532','2007241125658', &
                    '2007243140015','2007250163415','2007256235855','2007258010105', &
                    '2007260042621','2007263022315'/)
      else
         p_date_s=(/'2007116001004','2007117224036','2007122134322','2007123222109', &
                    '2007125142345','2007126050610','2007127104507','2007128041929', &
                    '2007129002458','2007129090157','2007130004529','2007130210851', &
                    '2007131170057','2007132173509','2007135040224','2007139125927', &
                    '2007141060956','2007142160043','2007144142439','2007156141017', &
                    '2007156182959','2007157044528','2007174020901','2007176123438', &
                    '2007177072142','2007178162254','2007184223950','2007187073141', &
                    '2007190133630','2007192154725','2007199225032','2007203060652', &
                    '2007206112147','2007210024704','2007215073037','2007220014847', &
                    '2007229043940','2007239135939','2007241122041','2007243134247', &
                    '2007250150652','2007256234130','2007258001905','2007260040726', &
                    '2007263014338'/)
      end if
   else if (trim(adjustl(cyear)) .eq. '2003') then
      if (.not. include_full_brdf) then
         p_date_s=(/'2007263074542','2007267073043','2007276133221','2007278190721', &
                    '2007279172043','2007283064232','2007285213619','2007287200010', &
                    '2007291121914','2007296155150','2007300133348','2007305072356', &
                    '2007309105757','2007312072616','2007316022749','2007316150956', &
                    '2007320121205','2007327061534','2007331103240','2007333133142', &
                    '2007336183923','2007339070832','2007341093512','2007346204849', &
                    '2007349094749','2007353092418','2007355154845','2007358165645', &
                    '2007360172903','2007363092858','2008002014243','2008004102539', &
                    '2008008062519','2008010211341','2008013022430','2008016050318', &
                    '2008018084933','2008021085017','2008028165507','2008029200354', &
                    '2008040200209','2008043025315','2008046152731','2008047044546', &
                    '2008050034405','2008101221508'/)

      else
         p_date_s=(/'2007263064301','2007267070607','2007276124354','2007278180828', &
                    '2007279164931','2007283061105','2007285210456','2007287190007', &
                    '2007291112605','2007296145958','2007300115218','2007305065240', &
                    '2007309102852','2007312070328','2007316014628','2007316144409', &
                    '2007320114046','2007326202451','2007331095304','2007333124408', &
                    '2007336180230','2007339064759','2007341090326','2007346201353', &
                    '2007349092920','2007353090022','2007355151738','2007358162452', &
                    '2007360171149','2007363091630','2008002012021','2008004095154', &
                    '2008008060329','2008010205546','2008013014250','2008016033849', &
                    '2008018080201','2008021080200','2008028164213','2008029195243', &
                    '2008040193134','2008043020754','2008046145821','2008047042231', &
                    '2008050031309','2008101215645' /)
      end if
   else if (trim(adjustl(cyear)) .eq. '2004') then
      if (.not. include_full_brdf) then
         p_date_s=(/'2007242054828','2007243171609','2007245163354','2007248054939', &
                    '2007251123341','2007254212649','2007258194709','2007259122547', &
                    '2007261122141','2007264173147','2007266100248','2007268220308', &
                    '2007271072102','2007272094335','2007278134852','2007281224105', &
                    '2007284060657','2007287065602','2007288130827','2007290050026', &
                    '2007293071106','2007295070036','2007297093324','2007299054922', &
                    '2007302045353','2007305141052','2007307025452','2007308144349', &
                    '2007310130344','2007315233134','2007315081048','2007316230328', &
                    '2007319175310','2007320015701','2007326235517','2007330205643', &
                    '2007332100739','2007333161632','2007335034827','2007336094754', &
                    '2007339142039','2007342050647','2007345073856','2007348202630', &
                    '2007351141417','2007353203528'/)
      else
         p_date_s=(/'2007242052316','2007243165635','2007245154432','2007248045836', &
                    '2007251120636','2007254200654','2007258191708','2007259114142', &
                    '2007261115724','2007264170049','2007266092915','2007268201923', &
                    '2007271065435','2007272093001','2007278131254','2007281215648', &
                    '2007284054514','2007287063253','2007288124348','2007290043550', &
                    '2007293045351','2007295042206','2007297070709','2007299022154', &
                    '2007302042218','2007305133427','2007307013811','2007308123930', &
                    '2007310124505','2007315225424','2007315073731','2007316222507', &
                    '2007319170057','2007320012255','2007326205809','2007330195041', &
                    '2007332084349','2007333145859','2007335020645','2007336084403', &
                    '2007339113044','2007342040822','2007345035018','2007348134045', &
                    '2007351134654','2007353174303'/)
      end if
   else if (trim(adjustl(cyear)) .eq. '2005') then
      if (.not. include_full_brdf) then
         p_date_s=(/'2007353052741','2007354122339','2007356071946','2007358040842', &
                    '2007360122925','2007362093353','2007364052842','2008004175828', &
                    '2008004165132','2008007033035','2008010071700','2008012063208', &
                    '2008020120133','2008022131839','2008024035752','2008026104503', &
                    '2008034051918','2008036064326','2008039160402','2008040061414', &
                    '2008042105524','2008044120547','2008046050611','2008048225037', &
                    '2008052022028','2008054144930','2008058174429','2008060015211', &
                    '2008063181833','2008066012052','2008067074616','2008068232706', &
                    '2008071021939','2008072103223','2008074164021','2008077201420', &
                    '2008079083632','2008082234539','2008085083646','2008086050638', &
                    '2008087085953','2008089100721','2008090072329','2008091115833', &
                    '2008094050508','2008094133450'/)
      else
         p_date_s=(/'2007353044307','2007354105929','2007356064904','2007358032811', &
                    '2007360120448','2007362090417','2007364045147','2008004112008', &
                    '2008004160319','2008006232307','2008010070143','2008012020124', &
                    '2008020104518','2008022125101','2008024031547','2008026074550', &
                    '2008034040346','2008036045435','2008039111618','2008040000939', &
                    '2008042102055','2008044083409','2008046043938','2008048155801', &
                    '2008052005308','2008054140945','2008058065850','2008060012725', &
                    '2008063142008','2008065234727','2008067052912','2008068225539', &
                    '2008070235811','2008072074117','2008074151718','2008077193830', &
                    '2008079075849','2008082232329','2008085072658','2008086024233', &
                    '2008087073755','2008089092400','2008090063237','2008091114722', &
                    '2008094043205','2008094071946'/)
      end if
   else if (trim(adjustl(cyear)) .eq. '2006') then
      if (.not. include_full_brdf) then
         p_date_s=(/'2008064175622','2008066040456','2008069082001','2008073033511', &
                    '2008076094541','2008079172700','2008083110142','2008088034159', &
                    '2008098064903','2008100021437','2008102195639','2008103220307', &
                    '2008107092214','2008112081724','2008116104001','2008123004824', &
                    '2008127092656','2008127052424','2008131080449','2008129235030', &
                    '2008132061527','2008136153452','2008141040517','2008141130720', &
                    '2008142180348','2008143033635','2008105224001','2008103014411', &
                    '2008107234221','2008108101158','2008109084348','2008110124823', &
                    '2008112225133','2008112164803','2008115224853','2008117054544', &
                    '2008118190339','2008123034728','2008124025017','2008125131258', &
                    '2008127163105','2008131225800','2008133060306','2008133233254', &
                    '2008135055428','2008135191019'/)
      else
         p_date_s=(/'2008064170626','2008066023748','2008069072216','2008073023442', &
                    '2008076090845','2008079160910','2008083102834','2008088031846', &
                    '2008098062104','2008100015937','2008102191023','2008103214447', &
                    '2008107090548','2008112074348','2008116094326','2008123002545', &
                    '2008127090629','2008127045548','2008131071240','2008129225514', &
                    '2008132055559','2008136142918','2008141035107','2008141125139', &
                    '2008142174149','2008143032441','2008105221302','2008102222031', &
                    '2008107194432','2008108071823','2008109074010','2008110113723', &
                    '2008112222903','2008112162734','2008115221312','2008117051137', &
                    '2008118185108','2008123031944','2008124023006','2008125124651', &
                    '2008127151212','2008131223442','2008133053419','2008133224917', &
                    '2008135054503','2008135190004'/)
      end if
   else if (trim(adjustl(cyear)) .eq. '2007') then
      if (.not. include_full_brdf) then
         p_date_s=(/'2007046104338','2007053121538','2007105022224','2007104152343', &
                    '2007106062618','2007107034849','2007094051850','2007100104315', &
                    '2007102104743','2007103233946','2007107051030','2007112101018', &
                    '2007130154342','2007135095112','2007141035826','2007144074928', &
                    '2007164033906','2007167180146','2007188105839','2007188085237', &
                    '2007192114809','2007202132921','2007204051426','2007211233709', &
                    '2007214154431','2007231084532','2007235181022','2007245082322', &
                    '2007248163744','2007262093737','2007265185631','2007276164428', &
                    '2007283151217','2007287082301','2007312052123','2007311190602', &
                    '2007316190504','2007335193346','2007338042306','2007341011248', &
                    '2007358135904','2007360070224','2007363144454','2008003081529', &
                    '2008009025819','2008019130651'/)
      else
         p_date_s=(/'2007046095140','2007053061447','2007105020525','2007104150846', &
                    '2007106060412','2007107030254','2007094045453','2007100101254', &
                    '2007102102901','2007103231212','2007107044501','2007112094641', &
                    '2007130152309','2007135091944','2007141031052','2007144071644', &
                    '2007164030809','2007167171935','2007188102223','2007188081437', &
                    '2007192110713','2007202125524','2007204042105','2007211230345', &
                    '2007214151315','2007231081238','2007235163839','2007245074258', &
                    '2007248160415','2007262084219','2007265182021','2007276144033', &
                    '2007283143609','2007287075528','2007312041922','2007311183657', &
                    '2007316183245','2007335190523','2007338041317','2007341004726', &
                    '2007358133218','2007360062905','2007363142450','2008003080409', &
                    '2008009024615','2008019123809'/)
      end if
   else if (trim(adjustl(cyear)) .eq. '2008') then
      if (.not. include_full_brdf) then
         p_date_s=(/'2008025111631','2008033123214','2008040004943','2008047121240', &
                    '2008054151035','2008065051535','2008071162739','2008080232812', &
                    '2008086173808','2008097191941','2008102161344','2008114201334', &
                    '2008121040804','2008127174047','2008134041158','2008143081725', &
                    '2008152172444','2008159034505','2008165135311','2008177220047', &
                    '2008184035707','2008192032521','2008199215458','2008205151447', &
                    '2008215000941','2008224075819','2008238210148','2008246050040', &
                    '2008251160923','2008256090501','2008271144514','2008277153013', &
                    '2008285034751','2008291033412','2008304210016','2008309142820', &
                    '2008312174054','2008331165258','2008335204416','2008339113335', &
                    '2008354114332','2008359104853','2008359104537','2009012201920', &
                    '2009019041257','2009034120609'/)
      else
!c1
         p_date_s=(/'2008025105553','2008033121048','2008040002910','2008047115105', &
                    '2008054143432','2008065045355','2008071155102','2008080224337', &
                    '2008086161825','2008097185201','2008102154441','2008114175808', &
                    '2008121032851','2008127165430','2008134035219','2008143080732', &
                    '2008152165510','2008159030800','2008165134327','2008177214849', &
                    '2008184034107','2008192031349','2008199213140','2008205144411', &
                    '2008214235620','2008224073152','2008238183726','2008246043229', &
                    '2008251153922','2008256083746','2008271133106','2008277134311', &
                    '2008285031334','2008291030744','2008304202109','2008309133835', &
                    '2008312165336','2008331155238','2008335201111','2008339111207', &
                    '2008354113030','2008359102804','2008359102557','2009012193211', &
                    '2009019035318','2009034113826'/)
      end if
   else if (trim(adjustl(cyear)) .eq. '2009') then
      if (.not. include_full_brdf) then
         p_date_s=(/'2009035033047','2009035093419','2009037163503','2009049045513', &
                    '2009064153637','2009066185433','2009068173243','2009086154612', &
                    '2009094144004','2009095045748','2009102120958','2009120060313', &
                    '2009127003905','2009130202842','2009134174328','2009142171615', &
                    '2009153033721','2009164033657','2009171032902','2009184041808', &
                    '2009187003552','2009203041731','2009206041253','2009213211007', &
                    '2009225080242','2009227031838','2009230094129','2009236062357', &
                    '2009250080227','2009254115141','2009261030822','2009269041609', &
                    '2009277230851','2009286145535','2009308044615','2009308095113', &
                    '2009310073001','2009316045157','2009323225354','2009345062739', &
                    '2009356112107','2009357180357','2009359042705','2009365230011', &
                    '2010013042737','2010022205422'/)
      else
         p_date_s=(/'2009035031723','2009035092205','2009037160556','2009049043731', &
                    '2009064045551','2009066182458','2009068171117','2009086152021', &
                    '2009094140217','2009095044508','2009102114722','2009120051928', &
                    '2009126234115','2009130195203','2009134170804','2009142163715', &
                    '2009153032007','2009164025556','2009171030813','2009184035708', &
                    '2009187001712','2009203035815','2009206035647','2009213202648', &
                    '2009225073355','2009227025714','2009230092216','2009236060943', &
                    '2009250074506','2009254110723','2009261024721','2009269035629', &
                    '2009277223801','2009286141933','2009308043205','2009308093510', &
                    '2009310071324','2009316043234','2009323223051','2009345060943', &
                    '2009356105656','2009357174048','2009359041714','2009365223206', &
                    '2010013041334','2010022200710'/)
      end if
   else if (trim(adjustl(cyear)) .eq. '2010') then
      if (.not. include_full_brdf) then
         p_date_s=(/'2010027235522','2010034002012','2010040023228','2010044091117', &
                    '2010053034308','2010064145456','2010070115206','2010100101037', &
                    '2010097110209','2010112133134','2010107113858','2010118064129', &
                    '2010119005604','2010139073433','2010140032537','2010141215238', &
                    '2010155002933','2010160002804','2010167015805','2010175035844', &
                    '2010180023454','2010195052141','2010199221400','2010204012137', &
                    '2010244023636','2010249220111','2010252192730','2010253011103', &
                    '2010254133200','2010256224611','2010262033745','2010274092421', &
                    '2010279094051','2010288065023','2010293115945','2010306052618', &
                    '2010313024208','2010320043437','2010325063355','2010332125021', &
                    '2010343014933','2010350012725','2011042105315','2011025133207', &
                    '2011025054213','2011025043810'/)
      else
         p_date_s=(/'2010027233124','2010033235907','2010040021749','2010044084932', &
                    '2010053033101','2010064142011','2010070105134','2010100094537', &
                    '2010097103758','2010112131539','2010107104946','2010118062641', &
                    '2010119002553','2010139070707','2010140025717','2010141213530', &
                    '2010154234518','2010159233006','2010167011848','2010175034512', &
                    '2010180021934','2010195050850','2010199215910','2010204010229', &
                    '2010244020347','2010249213744','2010252184336','2010253005106', &
                    '2010254131256','2010256221857','2010262032714','2010274090957', &
                    '2010279091734','2010288063553','2010293113521','2010306051152', &
                    '2010313022830','2010320041041','2010325062019','2010332123640', &
                    '2010343013625','2010350011421','2011042103219','2011025130745', &
                    '2011025052328','2011025041249'/)
      endif
   else if (trim(adjustl(cyear)) .eq. '2011') then
      if (.not. include_full_brdf) then
         p_date_s=(/'2011032064909','2011036121757','2011043101556','2011049045026', &
                    '2011059124014','2011061130757','2011076001809','2011078193700', &
                    '2011085133938','2011099085536','2011105101856','2011118211727', &
                    '2011120060005','2011125034517','2011141040903','2011142150811', &
                    '2011156052440','2011160061832','2011176155635','2011176214903', &
                    '2011187171402','2011188172834','2011195230948','2011216175732', &
                    '2011217025728','2011227172343','2011234051140','2011238195750', &
                    '2011243232318','2011252003220','2011259171633','2011269194925', &
                    '2011279214450','2011293215909','2011294235850','2011301170239', &
                    '2011311173819','2011319182459','2011325181259','2011335182516', &
                    '2011347182908','2011349203340','2011355164128','2011364165752', &
                    '2012009192000','2012013200200'/)
      else
         p_date_s=(/'2011032062814','2011036114952','2011043095135','2011049043221', &
                    '2011059120239','2011061125507','2011075234229','2011078185639', &
                    '2011085132459','2011099080053','2011105100603','2011118204856', &
                    '2011120054213','2011125032930','2011141035702','2011142145537', &
                    '2011156050346','2011160055922','2011176151654','2011176213034', &
                    '2011187171011','2011188172539','2011195230650','2011216174934', &
                    '2011217025215','2011227165928','2014185010058','2014185065911', &
                    '2014185005348','2014185005705','2014185015220','2014185005723', &
                    '2014185011604','2014185015409','2014185014949','2014185015107', &
                    '2014185003818','2014185004545','2014185003820','2014185002911', &
                    '2014185002724','2014185002339','2014185001129','2014185000609', &
                    '2014185005738','2014185011530'/)
      endif
   else if (trim(adjustl(cyear)) .eq. '2012') then
      if (.not. include_full_brdf) then
         p_date_s=(/'2012020183119','2012027193645','2012048173857','2012052180320', &
                    '2012053200106','2012067192902','2012069224310','2012075224030', &
                    '2012084014947','2012093210614','2012108213744','2012110182220', &
                    '2012117172300','2012122224953','2012138193414','2012142192753', &
                    '2012153193229','2012163170841','2012167181215','2012172191234', &
                    '2012179183546','2012191083600','2012212062413','2012209201434', &
                    '2012214193023','2012221211301','2012229180945','2012235012237', &
                    '2012243183829','2012251191103','2012262213144','2012271190947', &
                    '2012277183131','2012300010806','2012300202214','2012307211800', &
                    '2012307185453','2012315024841','2012324224928','2012338211958', &
                    '2012342000439','2012347204521','2012359222720','2012366184950', &
                    '2013008221553','2013014191050'/)
      else
         p_date_s=(/'2014185005658','2014185010437','2014185053001','2014185053902', &
                    '2014185053614','2014185052907','2014185053154','2014185054225', &
                    '2014185051813','2014185052332','2014185020755','2014185013039', &
                    '2014185054103','2014185054310','2014185054949','2012142191420', &
                    '2012153191859','2012163170521','2012167180707','2012172190711', &
                    '2012179183118','2012191083052','2012212061415','2012209200021', &
                    '2012214192144','2012221210837','2014185061737','2014185055012', &
                    '2014185053949','2014185054624','2014185054530','2014185072258', &
                    '2014185085318','2014185064522','2014185064716','2014185063723', &
                    '2014185061800','2014185104059','2014185103956','2014185101458', &
                    '2014185100303','2014185095949','2014185071656','2014185100213', &
                    '2014185100933','2014185101357'/)
      endif
   else if (trim(adjustl(cyear)) .eq. '2013') then
      if (.not. include_full_brdf) then
         p_date_s=(/'2013022185113','2013028190350','2013042163754','2013043210756', &
                    '2013053190956','2013061043626','2013072191930','2013075032726', &
                    '2013082231547','2013091183000','2013099021540','2013108035024', &
                    '2013115191310','2013127174512','2013133184851','2013144194633', &
                    '2013148202333','2013161194407','2013165034738','2013172204304', &
                    '2013182213458','2013191204312','2013198173829','2013207031134', &
                    '2013217231925','2013222090726','2013229023200','2013238213541', &
                    '2013246101830','2013255142712','2013268031535','2013269154913', &
                    '2013281062316','2013302020700','2013305001606','2013305181905', &
                    '2013317050005','2013318002042','2013322210531','2013337023253', &
                    '2013339191747','2013347061849','2013357181332','2013364184046', &
                    '2014007205854','2014016203743'/)
      else
         p_date_s=(/'2014185100509','2014185102654','2014185102231','2013043210052', &
                    '2013053190242','2013061043004','2013072185758','2013075032024', &
                    '2013082225624','2013091180248','2013099021059','2013108033959', &
                    '2013115190319','2013127173949','2013133184245','2013144193105', &
                    '2013148201203','2013161193751','2013165034005','2013172203345', &
                    '2013182211544','2013191203423','2013198170618','2013207030502', &
                    '2013217230951','2013222085353','2013229020932','2013238212532', &
                    '2013246100717','2013255141806','2013268025959','2013269153835', &
                    '2013281060607','2013302014005','2013305001121','2013305181036', &
                    '2013317043829','2013318000947','2013322205750','2013337022410', &
                    '2013339190643','2013347021821','2013357180350','2013364182936', &
                    '2014007204757','2014016192000'/)
      endif
   else if (trim(adjustl(cyear)) .eq. '2014') then
      if (.not. include_full_brdf) then
         p_date_s=(/'2014023213216','2014031103904','2014041200709','2014050031231', &
                    '2014059074634','2014059080946','2014066204505','2014084042152', &
                    '2014087181220','2014092043158','2014099001557','2014113182148', &
                    '2014115182620','2014125183729','2014133011031','2014139175827', &
                    '2014148185148','2014154200524','2014163181413','2014171200532', &
                    '2014179003220','2014189212611','2014195180457','2014203105249', &
                    '2014212021519','2014218205102','2014227191535','2014237203149', &
                    '2014247181525','2014252185231','2014276231121','2014279051547', &
                    '2014279203624','2014284073452','2014298012202','2014301041851', &
                    '2014311031009','2014316224735','2014324221331','2014330205301', &
                    '2014340001507','2014349232625','2014356195726','2014365172653', &
                    '2015007200146','2015021184328'/)
      else
         p_date_s=(/'2014023210532','2014031102338','2014041195655','2014050030405', &
                    '2014059073751','2014059080142','2014066203516','2014084035615', &
                    '2014087174506','2014092040504','2014099001032','2014113181633', &
                    '2014115182116','2014125183032','2014133010543','2014139175024', &
                    '2014148183504','2014154195938','2014163180512','2014171200022', &
                    '2014179002738','2014189211418','2014195175554','2014203104733', &
                    '2014212021014','2014218204259','2014227191048','2014237202233', &
                    '2014247175402','2014252184127','2014276230307','2014279050029', &
                    '2014279201402','2014284072526','2014298010253','2014301041204', &
                    '2014311025928','2014316223751','2014324220250','2014330204007', &
                    '2014340000750','2014349231425','2014356194803','2014365172223', &
                    '2015007195134','2015021181335'/)
      endif
   else
      write(*,*) 'ERROR: select_modis_albedo_file(): year not supported'
      stop error_stop_code
   end if

   ! Find the closest data
   allocate(newdates(nv))
   read(cdoy, *) doy
   newdates = abs(dates-doy)

   pos = minloc(newdates)

   mcd_date_s   = dates_s(pos(1))
   mcd_p_date_s = p_date_s(pos(1))

   if (include_full_brdf) then
      modis_surf_path_file=trim(adjustl(modis_surf_path))//'/'//'MCD43C1.A'//&
           trim(adjustl(cyear))//trim(adjustl(mcd_date_s))//'.005.'//&
           trim(adjustl(mcd_p_date_s))//'.hdf'
   else
      modis_surf_path_file=trim(adjustl(modis_surf_path))//'/'//'MCD43C3.A'//&
           trim(adjustl(cyear))//trim(adjustl(mcd_date_s))//'.005.'//&
           trim(adjustl(mcd_p_date_s))//'.hdf'
   end if

   ! Check that the defined file exists and is readable
   inquire(file=trim(modis_surf_path_file), exist=modis_surf_file_exist, &
      read=modis_surf_file_read)
   if (.not.modis_surf_file_exist) then
      write(*,*) 'ERROR: select_modis_albedo_file(): MODIS surface albedo ' // &
               & 'file does not exist, filename: ', trim(modis_surf_path_file)
      stop error_stop_code
   else if (trim(modis_surf_file_read).eq.'NO') then
      write(*,*) 'ERROR: select_modis_albedo_file(): MODIS surface albedo ' // &
               & 'file exists but is not readable, filename: ', trim(modis_surf_path_file)
      stop error_stop_code
   end if

   deallocate(dates)
   deallocate(dates_s)
   deallocate(p_date_s)
   deallocate(newdates)

end subroutine select_modis_albedo_file
