<!doctype html public "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <meta name="Author" content="Phil Watts">
   <meta name="GENERATOR" content="Mozilla/4.72 [en] (X11; I; OSF1 V5.1 alpha) [Netscape]">
   <title>ORAC output overview</title>
</head>
<body>

<center>
<h1>Outputs - overview</h1>
<hr WIDTH="100%"></center>
This overview describes the ORAC output data stream.
<h2>
<b><font color="#000000"><font size=+1>General</font></font></b></h2>
The output from ORAC consists of
<blockquote><b>1. </b>Header information (or 'metadata') i.e. the Ctrl
structure (defining all the controlling parameters / filenames etc for
the run). This information is written to the files containing the inversion
results.
Note May 2011: Ctrl struct is not currently written to the output files but it is TBC 
whether it will be re-introduced. 
<br><b>2.</b> Log information showing error or warning messages and codes,
overall timings and run dates etc. This is written to the log file (overall
run statistics are currently output to stdout).
<br><b>3</b>. Inversion outputs.
<br><b>4. </b>Breakpoint outputs (optional). These are intended for debugging
purposes and can optionally be included as part of the compilation and
build of the code or test harnesses. These are not discussed here but
further information can be found in the details of build procedures.</blockquote>

<h2>
<font size=+1>Inversion</font></h2>
Inversion output consists of
<blockquote><b>1.</b> Retrieved parameter values; [ X(1), X(2), X(3), X(4),
X(5) ], i.e. Tau, Re, Pc, f, Ts. Note, all parameters are present whether
or not they were <i>active</i> in the retrieval. Parameters that were inactive
remain at their a priori values.
<p><b>2. </b>Errors in the retrieved parameter values, i.e. the square
roots of the diagonals of the error covariance returned by the inversion
process.
<p><b>3.</b> Diagnostic information of various types. Because of the high
degree of diagnostic information possible from an OE retrieval, the ORAC code 
does not use a 'diagnostic level' flag determining what level of complexity
is required but instead uses an array of flags to enable the user to request
any or all of the information. The flags are stored in CTRL%DIAGL().
<br>&nbsp;
<blockquote><b>Flag 1</b>: <b><font color="#FF0000">QC flag</font></b>.
A one byte integer with individual bits set to indicate non-convergence
and / or unacceptable quality in the corresponding state parameter. A parameter
retrieval is deemed unacceptable if
<blockquote>a) The retrieval did not converge <font size=-1>(bits 1:MaxStateVar
and MaxStateVar+1 set)</font>
<br>b) The retrieval solution cost exceeds a set threshold (in CTRL%QC%MaxJ).
<font size=-1>(bits
1:MaxStateVar and MaxStateVar+2 set)</font>
<br>c) The parameter estimated retrieval error exceeds a set threshold
(in CTRL%QC%MaxS(i)). <font size=-1>(bit i set)</font></blockquote>
Example: if the retrieval converged but parameters 2 and 3 (Re and Pc)
were of high expected error,&nbsp; the QC flag would be set = 6.
<p><b>Flag 2</b>: <b><font color="#FF0000">Iterations</font></b>. A one
byte integer set to the number of iterations taken to solution. A value
of -1 is present if the retrieval did not converge.
<p><b>Flag 3</b>: <b><font color="#FF0000">Phase changes</font></b>. A
one byte integer set to the number of phase changes taken to solution.
A value of -1 is present if this exceeded the maximum permitted and consequently
the retrieval did not converge.
<p><b>Flag 4</b>: <b><font color="#FF0000">Costs</font></b>. Two real numbers
set to the separate solution <a href="#costs">costs</a>,
<b>J<sub>m</sub>,
J<sub>a.</sub></b>
<p><b>Flag 5</b>: <b><font color="#FF0000">S<sub>T</sub> State expected
error (1)</font></b>. The first state expected error is the theoretical
error arising from measurement errors and from the 'null space' or 'apriori'
sources (indeterminancy from the underconstrained nature of the situation).
A value is given for each <i>active</i> state vector element and is derived
from the inverse of the Hessian matrix at the solution: <b>S<sub>T</sub></b>=
(<b>K<sub>x</sub><sup>T</sup>.S<sub>y</sub><sup>-1</sup>.K<sub>x </sub></b>+
<b>S<sub>x</sub><sup>-1</sup></b>)<b><sup>-1</sup></b>.
When flag 5 is set, the <b><font color="#3366FF">Square Root of the diagonals</font></b>
of this matrix are written.
<p><b>Flag 6</b>: <b><font color="#FF0000">S<sub>s</sub> State expected
error (2)</font></b>. The second state expected error is the theoretical
error arising from the 'model parameter' noise, i.e. parameters that affect
the measurements but that are not retrieved. Model parameters include all
<i>inactive</i>
state variables and any fixed model parameters in the ECP implementation
(surface reflectance, R<sub>s</sub>, is the only current one with a gradient
calculation available). However, the contribution from a fixed model parameter
is <b>not</b> included if the EQMPN method for it has been invoked as in
this case the parameters contribution to the error is implicitly included
in the <b>S<sub>T </sub></b>term. The expression for <b>S<sub>s</sub></b>is<b>(D<sub>y</sub>K<sub>b</sub>)S<sub>b</sub>(D<sub>y</sub>K<sub>b</sub>)<sup>T</sup></b>where
<p><b>D<sub>y </sub></b>= d(<b>retrieval</b>)/d<b>y</b> = (<b>K<sub>x</sub><sup>T</sup>.S<sub>y</sub><sup>-1</sup>.K<sub>x
</sub></b>+
<b>S<sub>x</sub><sup>-1</sup></b>)<b><sup>-1</sup></b>.
<b>K<sub>x</sub><sup>T</sup>S<sub>y</sub><sup>-1
</sup></b>=
<b>S<sub>T</sub>K<sub>x</sub><sup>T</sup>S<sub>y</sub><sup>-1</sup></b>
<p>and is the retrieval operator - the response of the retrieval to the
measurements,
<p><b>K<sub>b </sub></b>= d<b>y</b>/d<b>b</b> = gradient of the measurements
wrt the model parameters and <b>S<sub>b </sub></b>is the model parameter
error covariance.
<p>When flag 6 is set, the <b><font color="#3333FF">Square Root of the
diagonals</font></b> of this matrix are written.
<p><b>Flag 7:</b> <b><font color="#FF0000">S<sub>T</sub> </font></b><font color="#000000">matrix
is written in full.</font>
<br><b>Flag 8:</b> <b><font color="#FF0000">S<sub>S</sub> </font></b><font color="#000000">matrix
is written in full.</font>
<br>&nbsp;</blockquote>
<font color="#000000">The following diagnostics are more intended for debugging
or investigative purposes:</font>
<blockquote>&nbsp;
<br><b>Flag 9</b>: <b><font color="#FF0000">Measurement fit</font></b>.
A real vector of length equal to the number of measurements used containing
the difference, at the last iteration, between the measurements and results
of the forward model calculation : <b>y<sub>m</sub> - y(x<sub>n</sub>)</b>.
(Summarised by measurement cost <b>J<sub>m</sub></b>, see bit 4.)
<p><b>Flag 9</b>: <b><font color="#FF0000">A priori fit</font></b>. A real
vector of length equal to the number of <i>active</i> state vector elements
used containing the difference, at the last iteration, between the a priori
and final state vector: <b>x<sub>b</sub> - x<sub>n</sub></b>. (Summarised
by a priori cost <b>J<sub>a</sub></b>, see bit 4.)
<p><b>Flag 10</b>: <b><font color="#FF0000">A priori value</font></b>.
A real vector length equal to the number of <i>active</i> state vector
elements used containing the a priori vector used in the retrieval, <b>x<sub>b</sub></b>.
<p><b>Flag 11</b>: <b><font color="#FF0000">First guess value</font></b>.
A real vector length equal to the number of <i>active</i> state vector
elements used containing the first guess vector used in the retrieval,
<b>x<sub>o</sub></b>.
<p><b>Flag 12</b>: <b><font color="#FF0000">A priori error</font></b>.
A real vector length equal to the number of <i>active</i> state vector
elements used containing the rms a priori errors used in the retrieval,
Root(<b>S<sub>x</sub></b>diagonals).
<p><b>Flag 13</b>: <b><font color="#FF0000">Measurement error</font></b>.
A real vector length equal to the number of measurements used conatining
the rms measurement errors used in the retrieval, Root(<b>S<sub>y</sub></b>diagonals).</blockquote>
</blockquote>

<h2>
The ORAC inversion output and diagnostics files</h2>
The ORAC output and diagnostic files are unformatted (i.e.
binary) sequential access files containing retrieved information for every
super-pixel in the requested image sub-area.
<p>The output file contains:
<ul>
<li>
<i>the entire Ctrl structure (currently not written, May 2011). The struct is written in a
single operation, and hence may be padded where variables do not end on
word boundaries, e.g. the date and time strings are not whole number multiples
of 4 bytes long so padding may occur after these. Padding is dependent
on the compiler/platform on which the code is executed.</i></li>

<li>
for each requested super-pixel, the retrieved state vector
(5 floating point values: Tau, Re, Pc, Fr, Ts) followed by the square roots
of the retrieved errors (again 5 floating point values representing the
diagonal terms of the matrix). This results in two end of record markers
being written per super-pixel (EOR markers may depend on platform), hence
12 * 4 bytes per super-pixel on a platform where a real is stored as 4
bytes.</li>
</ul>
The diagnostic file contains:
<ul>
<li>
the entire Ctrl structure. See comments for the output file.</li>

<li>
for each requested super-pixel, the parts of the Diag structure
selected by the user via the Ctrl%Diagl flag array (see above). Hence the
diagnostic file size varies depending on the setting of this flag array.</li>
</ul>

<hr WIDTH="100%">
</body>
</html>
